# Fetching and verifying raw sev-snp report

Welcome to this comprehensive guide to installing tpm2-tss from source and verifying raw AMD SEV-SNP manually on Linux. Throughout this guide, you will follow a step-by-step process to set up tpm2-tss, a TPM2.0 Software Stack, in your environment, leveraging its unique security features. Furthermore, you will also learn to fetch and verify raw AMD SEV-SNP manually.

It is worth mentioning that the material presented here is largely inspired by the resources available at  [GitHub-TPM2-TSS](https://github.com/tpm2-software/tpm2-tss/blob/master/INSTALL.md) and [Cvm-guest-attestation · GitHub](https://github.com/Azure/confidential-computing-cvm-guest-attestation/blob/main/cvm-guest-attestation.md) . This lab leverages that content, and you can refer to this resource to delve deeper.

## Installing the tpm2-tss [Github-TPM2-TSS](https://github.com/tpm2-software/tpm2-tss/blob/master/INSTALL.md)
## Dependencies
To build and install the tpm2-tss software, the following software packages are required. As many dependencies are platform-specific, the sections below describe them for the supported platforms.


## GNU/Linux:
* GNU Autoconf
* GNU Autoconf Archive, version >= 2019.01.06
* GNU Automake
* GNU Libtool
* C compiler
* C library development libraries and header files
* pkg-config
* doxygen
* OpenSSL development libraries and header files, version >= 1.1.0
* libcurl development libraries
* Access Control List utility (acl)
* JSON C Development library
* Package libusb-1.0-0-dev


The following are dependencies only required when building test suites.
* Integration test suite (see ./configure option --enable-integration):
    - uthash development libraries and header files
    - ps executable (usually in the procps package)
    - ss executable (usually in the iproute2 package)
    - tpm_server executable (from https://sourceforge.net/projects/ibmswtpm2/)
* Unit test suite (see ./configure option --enable-unit):
    - cmocka unit test framework, version >= 1.0
* Code coverage analysis:
    - lcov

Most users will not need to install these dependencies.

### Clone the repo 

```
git clone https://github.com/tpm2-software/tpm2-tss.git && cd tpm2-tss/
```

### Ubuntu
```
sudo apt -y update && sudo apt -y install \
  autoconf-archive \
  libcmocka0 \
  libcmocka-dev \
  procps \
  iproute2 \
  build-essential \
  git \
  pkg-config \
  gcc \
  libtool \
  automake \
  libssl-dev \
  uthash-dev \
  autoconf \
  doxygen \
  libjson-c-dev \
  libini-config-dev \
  libcurl4-openssl-dev \
  uuid-dev \
  libltdl-dev \
  libusb-1.0-0-dev \
  libftdi-dev
```
Note: In some Ubuntu versions, the lcov and autoconf-archive packages are incompatible with each other. It is recommended to download autoconf-archive directly from upstream and copy `ax_code_coverage.m4` and `ax_prog_doxygen.m4` to the `m4/` subdirectory of your tpm2-tss directory.


# Building From Source
## Bootstrapping the Build
To configure the tpm2-tss source code first run the bootstrap script, which
generates list of source files, and creates the configure script:
```
./bootstrap
```

Any options specified to the bootstrap command are passed to `autoreconf(1)`.

## Configuring the Build

Then run the configure script, which generates the makefiles:
```
./configure
```

## Compiling the Libraries
Then compile the code using make:
```
make -j$(nproc)
```

## Installing the Libraries
Once you've built the tpm2-tss software it can be installed with:
```
sudo make install
```

This process will install the libraries to a location determined at the time of configuration. You can see the available options in the output of `./configure --help`. Typically, you won't need to do much more than providing an alternative `--prefix` option at the time of configuration. You might also need to provide the `DESTDIR` at the time of installation if you're packaging.


# Post-install

## udev
Once you've installed this udev rule in the appropriate location for your distribution, you need to instruct udev to reload its rules and apply the new one. This can typically be accomplished with the following command:


```
sudo udevadm control --reload-rules && sudo udevadm trigger
```

If this doesn't work on your distro please consult your distro's
documentation for UDEVADM(8).

## ldconfig

It may be necessary to run `ldconfig` (as root) to update the run-time bindings before executing a program that links against `libsapi` or a TCTI library:

```
sudo ldconfig
```

# Fetching and verifying raw AMD SEV-SNP manually

# Linux  [Cvm-guest-attestation · GitHub](https://github.com/Azure/confidential-computing-cvm-guest-attestation/blob/main/cvm-guest-attestation.md)

1. After completing the above steps, install `tpm2-tools`.

```bash
sudo apt install tpm2-tools
```

2. Execute the following command to extract the raw SNP report from the vTPM NVRAM. This report was pre-generated by the HCL at boot and will be dumped in binary form. Note that this is **not** a dynamically generated report.


```    
sudo tpm2_nvread -C o 0x01400001 > ./snp_report.bin
```

```
dd skip=32 bs=1 count=1184 if=./snp_report.bin of=./attestation_report.bin
```

### Cloning the virtee/snpguest Repository

```bash
git clone https://github.com/virtee/snpguest && cd snpguest
```

### Building the snpguest Tool

First we are going to install rust

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```
```bash
echo 'source $HOME/.cargo/env' >> $HOME/.bashrc
```



```bash
source $HOME/.cargo/env
rustc --version
```
Output:

rustc 1.70.0 (90c541806 2023-05-31)


##### Build the snpguest tool using cargo.

```bash
cargo build -r
cd target/release
```
### Preparing the Environment for Verification


Please replace the attestation_report.bin file and directory paths according to your specific situation.

```bash
mkdir certs
cp <your_attestation_report.bin_file_path> .
```
### Fetching the Required Certificates

```bash
./snpguest fetch ca milan certs && ./snpguest fetch vcek milan certs
```

### Verifying the Certificates
```bash
./snpguest verify certs certs/
```

The AMD ARK was self-signed! 


The AMD ASK was signed by the AMD ARK! 


The VCEK was signed by the AMD ASK!


### Verifying the TCB

```bash
./snpguest verify tcb certs/ -a attestation_report.bin 
```

Output:

Reported TCB Boot Loader from certificate matches the attestation report.


Reported TCB TEE from certificate matches the attestation report.


Reported TCB SNP from certificate matches the attestation report.


Reported TCB Microcode from certificate matches the attestation report.


Chip ID from certificate matches the attestation report.


### Verifying the Signature
```bash
./snpguest verify signature certs/ -a attestation_report.bin 
```

Output:

VCEK signed the Attestation Report!
